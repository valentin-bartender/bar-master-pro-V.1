<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar Master Pro - Final Build</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #0a0a0a; color: #fff; height: 100vh; overflow: hidden; }
        .container { display: flex; flex-direction: column; height: 100vh; }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen { display: none; height: 100%; }
        .screen.active { display: flex; flex-direction: column; }

        /* –ú–µ–Ω—é */
        #screen-menu { justify-content: center; align-items: center; background: radial-gradient(circle, #1e1b4b 0%, #000 100%); }
        .menu-card { background: rgba(255,255,255,0.05); padding: 40px; border-radius: 20px; border: 1px solid #22d3ee; text-align: center; max-width: 500px; }
        .mode-btn { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #22d3ee; background: transparent; color: #22d3ee; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .mode-btn:hover { background: #22d3ee; color: #000; box-shadow: 0 0 20px #22d3ee; }

        /* Header */
        .header { background: #111; padding: 12px 20px; border-bottom: 2px solid #22d3ee; display: flex; justify-content: space-between; align-items: center; }
        .stat-box { padding: 6px 12px; border-radius: 6px; border: 1px solid #22d3ee; font-size: 13px; background: rgba(34, 211, 238, 0.1); }

        /* Layout */
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        .game-area { width: 70%; padding: 15px; overflow-y: auto; background: #0f1115; border-right: 1px solid #333; }
        .side-panel { width: 30%; background: #111; padding: 15px; display: flex; flex-direction: column; gap: 15px; }

        /* –°–µ–ª–µ–∫—Ç–æ—Ä—ã */
        .grid-select { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-bottom: 15px; }
        .select-btn { padding: 10px; background: #1a1a1a; border: 1px solid #444; color: #fff; border-radius: 6px; cursor: pointer; font-size: 10px; }
        .select-btn.active { border-color: #f472b6; background: rgba(244, 114, 182, 0.2); }

        /* –ë—É—Ç—ã–ª–∫–∏ */
        .bottles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 8px; }
        .bottle-card { background: #1a1a1a; padding: 8px; border-radius: 6px; text-align: center; border: 1px solid #333; }
        .pour-btn { background: #333; border: none; color: #22d3ee; padding: 5px; font-size: 9px; cursor: pointer; margin: 1px; border-radius: 3px; }

        .finish-btn { width: 100%; padding: 15px; border-radius: 8px; background: #10b981; color: #fff; font-weight: bold; border: none; cursor: pointer; }
        
        .feedback-box { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; border: 1px solid #444; flex-grow: 1; overflow-y: auto; font-size: 11px; }
        .err-text { color: #ff4444; margin-bottom: 4px; }
        .success-text { color: #10b981; font-weight: bold; }

        /* –§—É—Ç–µ—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .controls-footer { position: fixed; bottom: 20px; left: 20px; display: flex; gap: 10px; }
        .float-btn { width: 45px; height: 45px; border-radius: 50%; background: #222; border: 1px solid #22d3ee; color: #fff; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        
        .hint-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a1a; border: 2px solid #ffd700; padding: 20px; border-radius: 10px; z-index: 1000; display: none; white-space: pre-line; box-shadow: 0 0 50px rgba(0,0,0,0.9); }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="screen-menu" class="screen active">
        <div class="menu-card">
            <h1 style="color:#22d3ee; margin-bottom:10px">BAR MASTER PRO</h1>
            <button class="mode-btn" onclick="startGame('work', 180)">–†–ê–ë–û–ß–ê–Ø –°–ï–°–°–ò–Ø (3 –ú–ò–ù)</button>
            <button class="mode-btn" onclick="startGame('work', 300)">–†–ê–ë–û–ß–ê–Ø –°–ï–°–°–ò–Ø (5 –ú–ò–ù)</button>
            <button class="mode-btn" onclick="startGame('marathon')">–ú–ê–†–ê–§–û–ù (–í–°–Å –ú–ï–ù–Æ)</button>
            <p style="font-size: 10px; color: #555; margin-top: 15px;">–§–∞–π–ª –º—É–∑—ã–∫–∏: music.mp3 –≤ –ø–∞–ø–∫–µ —Å –∏–≥—Ä–æ–π</p>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="header">
            <div class="header-title">üç∏ <span id="display-mode">–°–ú–ï–ù–ê</span></div>
            <div class="header-stats">
                <div class="stat-box">‚è±Ô∏è <span id="timer">00:00</span></div>
                <div class="stat-box">‚≠ê <span id="score-counter">0/0</span></div>
                <div class="stat-box" style="color:#f472b6">–ó–ê–ö–ê–ó: <b id="order-name">---</b></div>
            </div>
        </div>

        <div class="main-layout">
            <div class="game-area">
                <div id="step-1">
                    <h4 style="color:#22d3ee; margin-bottom:10px">–≠–¢–ê–ü 1: –ü–û–î–ì–û–¢–û–í–ö–ê</h4>
                    <div class="grid-select" id="glass-grid"></div>
                    <div class="grid-select" id="tool-grid"></div>
                    <button class="finish-btn" onclick="changeStep(2)">–ü–ï–†–ï–ô–¢–ò –ö –ù–ê–õ–ò–í–£</button>
                </div>

                <div id="step-2" class="hidden">
                    <h4 style="color:#22d3ee; margin-bottom:10px">–≠–¢–ê–ü 2: –ò–ù–ì–†–ï–î–ò–ï–ù–¢–´</h4>
                    <div id="tabs-bar" style="margin-bottom:10px"></div>
                    <div id="bottles-grid" class="bottles-grid"></div>
                    <div style="margin-top:15px; font-size:11px; background: #222; padding: 5px;">–í –ë–û–ö–ê–õ–ï: <span id="current-mix">–ü—É—Å—Ç–æ</span></div>
                    <button class="finish-btn" style="margin-top:10px" onclick="changeStep(3)">–ö –ì–ê–†–ù–ò–†–£</button>
                </div>

                <div id="step-3" class="hidden">
                    <h4 style="color:#22d3ee; margin-bottom:10px">–≠–¢–ê–ü 3: –ì–ê–†–ù–ò–†</h4>
                    <div class="grid-select" id="garnish-grid"></div>
                </div>
            </div>

            <div class="side-panel">
                <h4 style="font-size: 11px; color: #22d3ee">–ü–û–°–õ–ï–î–ù–ò–ô –†–ï–ó–£–õ–¨–¢–ê–¢:</h4>
                <div class="feedback-box" id="live-feedback">–ü—Ä–∏—Å—Ç—É–ø–∞–π—Ç–µ –∫ —Ä–∞–±–æ—Ç–µ!</div>
                <button onclick="resetMix()" style="padding:10px; background:#431407; border:none; color:white; border-radius:5px; cursor:pointer; font-size:11px">–°–ë–†–û–°–ò–¢–¨ –°–û–°–¢–ê–í</button>
            </div>
        </div>
    </div>
</div>

<div id="hint-box" class="hint-overlay"></div>
<div class="controls-footer">
    <button class="float-btn" onclick="toggleHint()">üí°</button>
    <button class="float-btn" onclick="toggleMusic()">üéµ</button>
</div>

<audio id="audio-player" loop src="https://cdn.pixabay.com/audio/2022/05/27/audio_1808fbf07a.mp3"></audio>

<script>
    // --- –û–ë–™–ï–ö–¢ –†–ï–¶–ï–ü–¢–û–í (–¢–æ—Ç —Å–∞–º—ã–π –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π –±–ª–æ–∫) ---
    const recipes = {
        // --- –®–û–¢–´ ---
        "B-52": { ing: {"–ë–µ–π–ª–∏—Å":20, "–ö–æ—Ñ–µ–π–Ω—ã–π –ª–∏–∫–µ—Ä":20, "–ê–ø–µ–ª—å—Å–∏–Ω–æ–≤—ã–π –ª–∏–∫–µ—Ä":20}, glass: "Shot", tool: "Layered", g: ["–ù–µ—Ç"] },
        "Uncle Bob": { ing: {"–í–æ–¥–∫–∞":30, "–°–∏—Ä–æ–ø –ì—Ä–µ–Ω–∞–¥–∏–Ω":10, "–õ–∏–º–æ–Ω–Ω—ã–π —Å–æ–∫":10}, glass: "Shot", tool: "Shaker", g: ["–ù–µ—Ç"] },
        "Fumari set": { ing: {"–í–æ–¥–∫–∞":80, "–ê–Ω–∞–Ω–∞—Å–æ–≤—ã–π —Å–æ–∫":40, "–°–∏—Ä–æ–ø –ú–∞—Ä–∞–∫—É–π—è":20, "–õ–∏–º–æ–Ω–Ω—ã–π —Å–æ–∫":10, "–ú–µ–¥":10}, glass: "Shot", tool: "Shaker", g: ["–ù–µ—Ç"] },

        // --- –ö–õ–ê–°–°–ò–ö–ê IBA ---
        "Negroni": { ing: {"–î–∂–∏–Ω":30, "–ö–∞–º–ø–∞—Ä–∏":30, "–ú–∞—Ä—Ç–∏–Ω–∏ –†–æ—Å—Å–æ":30}, glass: "Old Fashioned", tool: "Stir", g: ["–ê–ø–µ–ª—å—Å–∏–Ω"] },
        "Old Fashioned": { ing: {"–ë—É—Ä–±–æ–Ω":45, "–ê–Ω–≥–æ—Å—Ç—É—Ä–∞":2, "–°–∞—Ö–∞—Ä":5}, glass: "Old Fashioned", tool: "Stir", g: ["–¶–µ–¥—Ä–∞ –ª–∏–º–æ–Ω–∞"] },
        "Dry Martini": { ing: {"–î–∂–∏–Ω":60, "–°—É—Ö–æ–π –≤–µ—Ä–º—É—Ç":10}, glass: "Martini Glass", tool: "Stir", g: ["–õ–∏–º–æ–Ω"] },
        "Whiskey Sour": { ing: {"–ë—É—Ä–±–æ–Ω":45, "–õ–∏–º–æ–Ω–Ω—ã–π —Å–æ–∫":30, "–°–∞—Ö–∞—Ä":15, "–ë–µ–ª–æ–∫":20}, glass: "Old Fashioned", tool: "Shaker", g: ["–õ–∏–º–æ–Ω"] },
        "Margarita": { ing: {"–¢–µ–∫–∏–ª–∞":35, "–ê–ø–µ–ª—å—Å–∏–Ω–æ–≤—ã–π –ª–∏–∫–µ—Ä":20, "–õ–∞–π–º":15}, glass: "Margarita Glass", tool: "Shaker", g: ["–°–æ–ª—è–Ω–∞—è –∫—Ä–æ–º–∫–∞"] },
        "Bloody Mary": { ing: {"–í–æ–¥–∫–∞":45, "–¢–æ–º–∞—Ç–Ω—ã–π —Å–æ–∫":90, "–õ–∏–º–æ–Ω–Ω—ã–π —Å–æ–∫":15, "–í–æ—Ä—á–µ—Å—Ç–µ—Ä":2, "–¢–∞–±–∞—Å–∫–æ":2}, glass: "Highball", tool: "Build", g: ["–õ–∏–º–æ–Ω"] },
        "Daiquiri": { ing: {"–†–æ–º":45, "–õ–∞–π–º":25, "–°–∞—Ö–∞—Ä":15}, glass: "Martini Glass", tool: "Shaker", g: ["–ù–µ—Ç"] },
        
        // --- –ü–û–ü–£–õ–Ø–†–ù–û–ï ---
        "Sex on the beach": { ing: {"–í–æ–¥–∫–∞":40, "–ü–µ—Ä—Å–∏–∫–æ–≤—ã–π –ª–∏–∫–µ—Ä":20, "–ö–ª—é–∫–≤–µ–Ω–Ω—ã–π –º–æ—Ä—Å":40, "–ê–Ω–∞–Ω–∞—Å–æ–≤—ã–π —Å–æ–∫":40}, glass: "Highball", tool: "Build", g: ["–ê–ø–µ–ª—å—Å–∏–Ω"] },
        "Mojito Classic": { ing: {"–†–æ–º":50, "–°–æ–¥–æ–≤–∞—è":100, "–õ–∞–π–º":20, "–ú—è—Ç–∞":1, "–°–∞—Ö–∞—Ä":2}, glass: "Highball", tool: "Muddle", g: ["–ú—è—Ç–∞"] },
        "Aperol Spritz": { ing: {"–ê–ø–µ—Ä–æ–ª—å":60, "–ò–≥—Ä–∏—Å—Ç–æ–µ –≤–∏–Ω–æ":90, "–°–æ–¥–æ–≤–∞—è":30}, glass: "Wine Glass", tool: "Build", g: ["–ê–ø–µ–ª—å—Å–∏–Ω"] },
        "Pina Colada": { ing: {"–†–æ–º":50, "–ê–Ω–∞–Ω–∞—Å–æ–≤—ã–π —Å–æ–∫":90, "–ö–æ–∫–æ—Å–æ–≤—ã–π —Å–∏—Ä–æ–ø":20, "–õ–∏–º–æ–Ω–Ω—ã–π —Å–æ–∫":10}, glass: "Hurricane", tool: "Shaker", g: ["–ê–Ω–∞–Ω–∞—Å"] },
        "Cosmopolitan": { ing: {"–í–æ–¥–∫–∞":40, "–ê–ø–µ–ª—å—Å–∏–Ω–æ–≤—ã–π –ª–∏–∫–µ—Ä":15, "–ö–ª—é–∫–≤–µ–Ω–Ω—ã–π –º–æ—Ä—Å":30, "–õ–∏–º–æ–Ω–Ω—ã–π —Å–æ–∫":10}, glass: "Martini Glass", tool: "Shaker", g: ["–¶–µ–¥—Ä–∞ –ª–∏–º–æ–Ω–∞"] },
        "Long Island": { ing: {"–í–æ–¥–∫–∞":15, "–†–æ–º":15, "–¢–µ–∫–∏–ª–∞":15, "–î–∂–∏–Ω":15, "–ê–ø–µ–ª—å—Å–∏–Ω–æ–≤—ã–π –ª–∏–∫–µ—Ä":15, "–õ–∏–º–æ–Ω–Ω—ã–π —Å–æ–∫":20, "–ü–µ–ø—Å–∏":50}, glass: "Highball", tool: "Build", g: ["–õ–∏–º–æ–Ω"] },
        "Dark 'n' Stormy": { ing: {"–ó–æ–ª–æ—Ç–æ–π —Ä–æ–º":60, "–°–æ–¥–æ–≤–∞—è":100, "–õ–∞–π–º":10}, glass: "Highball", tool: "Build", g: ["–õ–∞–π–º"] },
        "French Martini": { ing: {"–í–æ–¥–∫–∞":45, "–ú–∞–ª–∏–Ω–æ–≤—ã–π –ª–∏–∫–µ—Ä":15, "–ê–Ω–∞–Ω–∞—Å–æ–≤—ã–π —Å–æ–∫":15}, glass: "Martini Glass", tool: "Shaker", g: ["–¶–µ–¥—Ä–∞ –ª–∏–º–æ–Ω–∞"] }
    };

    // --- –ò–ù–ì–†–ï–î–ò–ï–ù–¢–´ ---
    const ingredients = {
        "–ê–ª–∫–æ–≥–æ–ª—å": ["–í–æ–¥–∫–∞", "–†–æ–º", "–ó–æ–ª–æ—Ç–æ–π —Ä–æ–º", "–î–∂–∏–Ω", "–¢–µ–∫–∏–ª–∞", "–ò–≥—Ä–∏—Å—Ç–æ–µ –≤–∏–Ω–æ", "–ë—É—Ä–±–æ–Ω", "–í–∏—Å–∫–∏"],
        "–õ–∏–∫–µ—Ä—ã": ["–ë–µ–π–ª–∏—Å", "–ö–æ—Ñ–µ–π–Ω—ã–π –ª–∏–∫–µ—Ä", "–ê–ø–µ–ª—å—Å–∏–Ω–æ–≤—ã–π –ª–∏–∫–µ—Ä", "–î—ã–Ω–Ω—ã–π –ª–∏–∫–µ—Ä", "–ü–µ—Ä—Å–∏–∫–æ–≤—ã–π –ª–∏–∫–µ—Ä", "–ê–ø–µ—Ä–æ–ª—å", "–ö–∞–º–ø–∞—Ä–∏", "–ú–∞–ª–∏–Ω–æ–≤—ã–π –ª–∏–∫–µ—Ä", "–°—É—Ö–æ–π –≤–µ—Ä–º—É—Ç", "–ú–∞—Ä—Ç–∏–Ω–∏ –†–æ—Å—Å–æ"],
        "–°–∏—Ä–æ–ø—ã": ["–°–∏—Ä–æ–ø –ì—Ä–µ–Ω–∞–¥–∏–Ω", "–°–∏—Ä–æ–ø –ë–ª—é –ö—É—Ä–∞—Å–∞–æ", "–ö–æ–∫–æ—Å–æ–≤—ã–π —Å–∏—Ä–æ–ø", "–ú–∏–Ω–¥–∞–ª—å–Ω—ã–π —Å–∏—Ä–æ–ø", "–°–∏—Ä–æ–ø –ú–∞—Ä–∞–∫—É–π—è", "–°–∏—Ä–æ–ø –ú–∞–Ω–≥–æ", "–°–∏—Ä–æ–ø –ö–∏–≤–∏", "–ú–µ–¥", "–°–∞—Ö–∞—Ä", "–ê–Ω–≥–æ—Å—Ç—É—Ä–∞"],
        "–°–æ–∫–∏/–ú–∏–∫—Å—ã": ["–ê–Ω–∞–Ω–∞—Å–æ–≤—ã–π —Å–æ–∫", "–ê–ø–µ–ª—å—Å–∏–Ω–æ–≤—ã–π —Å–æ–∫", "–ü–µ—Ä—Å–∏–∫–æ–≤—ã–π —Å–æ–∫", "–õ–∏–º–æ–Ω–Ω—ã–π —Å–æ–∫", "–ö–ª—é–∫–≤–µ–Ω–Ω—ã–π –º–æ—Ä—Å", "–°–æ–¥–æ–≤–∞—è", "–ü–µ–ø—Å–∏", "–ú–æ–ª–æ–∫–æ", "–¢–æ–º–∞—Ç–Ω—ã–π —Å–æ–∫", "–ë–µ–ª–æ–∫", "–í–æ—Ä—á–µ—Å—Ç–µ—Ä", "–¢–∞–±–∞—Å–∫–æ"],
        "–°–≤–µ–∂–µ–µ": ["–õ–∞–π–º", "–ú—è—Ç–∞", "–ë–∞–Ω–∞–Ω", "–ö–∏–≤–∏", "–ê–ø–µ–ª—å—Å–∏–Ω", "–õ–∏–º–æ–Ω", "–ê–Ω–∞–Ω–∞—Å", "–¶–µ–¥—Ä–∞ –ª–∏–º–æ–Ω–∞", "–°–æ–ª—è–Ω–∞—è –∫—Ä–æ–º–∫–∞"]
    };

    const ui = {
        glasses: ["Shot", "Highball", "Martini Glass", "Margarita Glass", "Hurricane", "Wine Glass", "Old Fashioned"],
        tools: ["Build", "Shaker", "Stir", "Layered", "Muddle"],
        garnishes: ["–ù–µ—Ç", "–õ–∞–π–º", "–ú—è—Ç–∞", "–ê–ø–µ–ª—å—Å–∏–Ω", "–õ–∏–º–æ–Ω", "–ê–Ω–∞–Ω–∞—Å", "–°–æ–ª—è–Ω–∞—è –∫—Ä–æ–º–∫–∞", "–¶–µ–¥—Ä–∞ –ª–∏–º–æ–Ω–∞"]
    };

    let state = {
        mode: '', time: 0, interval: null,
        orders: [], currentIdx: 0,
        build: { ing: {}, glass: '', tool: '' },
        score: 0, history: [], startTime: 0
    };

    function toggleMusic() {
        const p = document.getElementById('audio-player');
        p.paused ? p.play().catch(()=>alert('–ù–∞–∂–º–∏ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å —Ñ–∞–π–ª music.mp3')) : p.pause();
    }

    function startGame(mode, sec = 0) {
        if (state.interval) clearInterval(state.interval);
        state.mode = mode;
        state.time = sec;
        state.orders = mode === 'work' ? Object.keys(recipes).sort(()=>Math.random()-0.5) : Object.keys(recipes);
        state.currentIdx = 0;
        state.score = 0;
        state.history = [];
        state.startTime = Date.now();

        document.getElementById('screen-menu').classList.remove('active');
        document.getElementById('screen-game').classList.add('active');
        document.getElementById('display-mode').innerText = mode === 'work' ? '–°–ï–°–°–ò–Ø' : '–ú–ê–†–ê–§–û–ù';
        
        renderUI();
        loadNextOrder();
        
        if(mode === 'work') {
            updateTimerDisplay();
            startTimer();
        } else {
            document.getElementById('timer').innerText = "00:00";
            startMarathonTimer();
        }
    }

    function startTimer() {
        state.interval = setInterval(() => {
            state.time--;
            updateTimerDisplay();
            if(state.time <= 0) finishGame("–í—Ä–µ–º—è –≤—ã—à–ª–æ!");
        }, 1000);
    }

    function startMarathonTimer() {
        state.interval = setInterval(() => {
            const diff = Math.floor((Date.now() - state.startTime) / 1000);
            const m = Math.floor(diff / 60), s = diff % 60;
            document.getElementById('timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        }, 1000);
    }

    function updateTimerDisplay() {
        let m = Math.floor(state.time / 60), s = state.time % 60;
        document.getElementById('timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
    }

    function renderUI() {
        document.getElementById('glass-grid').innerHTML = ui.glasses.map(g => `<button class="select-btn" onclick="selectAttr('glass', '${g}', this)">${g}</button>`).join('');
        document.getElementById('tool-grid').innerHTML = ui.tools.map(t => `<button class="select-btn" onclick="selectAttr('tool', '${t}', this)">${t}</button>`).join('');
        document.getElementById('garnish-grid').innerHTML = ui.garnishes.map(g => `<button class="select-btn" onclick="submitCocktail('${g}')">${g}</button>`).join('');
        
        const tabs = Object.keys(ingredients);
        document.getElementById('tabs-bar').innerHTML = tabs.map(t => `<button class="select-btn" style="width:auto; margin-right:5px" onclick="renderBottles('${t}')">${t}</button>`).join('');
        renderBottles(tabs[0]);
    }

    function loadNextOrder() {
        const name = state.orders[state.currentIdx];
        document.getElementById('order-name').innerText = name;
        document.getElementById('score-counter').innerText = `${state.score}/${state.orders.length}`;
        
        const r = recipes[name];
        let h = `<b>–†–ï–¶–ï–ü–¢: ${name}</b>\n`;
        for(let [i, v] of Object.entries(r.ing)) h += `‚Ä¢ ${i}: ${v}ml\n`;
        h += `\n–ë–æ–∫–∞–ª: ${r.glass}\n–ú–µ—Ç–æ–¥: ${r.tool}\n–ì–∞—Ä–Ω–∏—Ä: ${r.g[0]}`;
        document.getElementById('hint-box').innerHTML = h;
        
        resetMix();
        changeStep(1);
    }

    function submitCocktail(garnish) {
        const target = recipes[state.orders[state.currentIdx]];
        const build = state.build;
        let errors = [];

        if(build.glass !== target.glass) errors.push(`–ë–æ–∫–∞–ª (–Ω—É–∂–µ–Ω ${target.glass})`);
        if(build.tool !== target.tool) errors.push(`–ú–µ—Ç–æ–¥ (–Ω—É–∂–µ–Ω ${target.tool})`);
        if(!target.g.includes(garnish)) errors.push(`–ì–∞—Ä–Ω–∏—Ä (–Ω—É–∂–µ–Ω ${target.g[0]})`);

        for(let [ing, val] of Object.entries(target.ing)) {
            if((build.ing[ing] || 0) !== val) errors.push(`${ing}: ${build.ing[ing]||0}/${val}ml`);
        }

        const feedbackEl = document.getElementById('live-feedback');
        if(errors.length === 0) {
            state.score++;
            feedbackEl.innerHTML = `<div class="success-text">‚úÖ ${state.orders[state.currentIdx]}: –ò–î–ï–ê–õ–¨–ù–û!</div>`;
        } else {
            feedbackEl.innerHTML = `<div style="color:#f472b6; font-weight:bold; margin-bottom:5px">‚ùå ${state.orders[state.currentIdx]}:</div>` + 
                                   errors.map(e => `<div class="err-text">‚Ä¢ ${e}</div>`).join('');
        }

        state.history.push({ name: state.orders[state.currentIdx], ok: errors.length === 0, errs: errors });
        state.currentIdx++;

        if(state.currentIdx >= state.orders.length) finishGame("–ú–µ–Ω—é –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!");
        else loadNextOrder();
    }

    function finishGame(reason) {
        clearInterval(state.interval);
        const finalTime = document.getElementById('timer').innerText;
        let report = `–ò–¢–û–ì–ò –°–ï–°–°–ò–ò\n\n${reason}\n–†–µ–∑—É–ª—å—Ç–∞—Ç: ${state.score} –∏–∑ ${state.currentIdx}\n–í—Ä–µ–º—è: ${finalTime}\n\n`;
        
        state.history.forEach(h => {
            report += `${h.ok ? '‚úÖ' : '‚ùå'} ${h.name}\n${h.errs.length ? '    ' + h.errs.join(', ') + '\n' : ''}`;
        });
        
        alert(report);
        location.reload();
    }

    function selectAttr(k, v, el) {
        state.build[k] = v;
        el.parentNode.querySelectorAll('.select-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }

    function addIng(n, v) {
        state.build.ing[n] = (state.build.ing[n] || 0) + v;
        document.getElementById('current-mix').innerText = Object.entries(state.build.ing).map(([i, vol]) => `${i}(${vol})`).join(', ');
    }

    function renderBottles(cat) {
        document.getElementById('bottles-grid').innerHTML = ingredients[cat].map(ing => `
            <div class="bottle-card">
                <div style="font-size:9px; height:20px; overflow:hidden">${ing}</div>
                <button class="pour-btn" onclick="addIng('${ing}', 10)">+10</button>
                <button class="pour-btn" onclick="addIng('${ing}', 20)">+20</button>
                <button class="pour-btn" onclick="addIng('${ing}', 5)">+5</button>
            </div>
        `).join('');
    }

    function changeStep(s) {
        [1,2,3].forEach(n => document.getElementById('step-'+n).classList.add('hidden'));
        document.getElementById('step-'+s).classList.remove('hidden');
    }

    function resetMix() {
        state.build = { ing: {}, glass: '', tool: '' };
        document.getElementById('current-mix').innerText = "–ü—É—Å—Ç–æ";
        document.querySelectorAll('.select-btn').forEach(b => b.classList.remove('active'));
    }

    function toggleHint() {
        const h = document.getElementById('hint-box');
        h.style.display = h.style.display === 'block' ? 'none' : 'block';
    }
</script>
</body>
</html>
