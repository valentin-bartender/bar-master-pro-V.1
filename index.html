<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bar Master Pro</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif; background: #0a0a0a; color: #fff; height: 100vh; overflow: hidden; }
    .container { display: flex; flex-direction: column; height: 100vh; }

    .screen { display: none; height: 100%; }
    .screen.active { display: flex; flex-direction: column; }

    #screen-menu { justify-content: center; align-items: center; background: radial-gradient(circle, #1e1b4b 0%, #000 100%); }
    .menu-card { background: rgba(255,255,255,0.05); padding: 26px; border-radius: 20px; border: 1px solid #22d3ee; text-align: center; max-width: 880px; width: min(880px, 94vw); }
    .mode-btn { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #22d3ee; background: transparent; color: #22d3ee; border-radius: 10px; cursor: pointer; font-weight: 900; transition: 0.25s; }
    .mode-btn:hover { background: #22d3ee; color: #000; box-shadow: 0 0 20px #22d3ee; }

    .header {
      background: #111;
      padding: 10px 12px;
      border-bottom: 2px solid #22d3ee;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: nowrap;
      min-height: 44px;
    }
    .header-title { display:flex; align-items:center; gap:8px; font-weight: 900; white-space: nowrap; }
    .header-right { display:flex; align-items:center; gap:8px; flex-wrap: nowrap; }
    .stat-box {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #22d3ee;
      font-size: 12px;
      background: rgba(34, 211, 238, 0.10);
      display:flex; gap:6px; align-items:center;
      white-space: nowrap;
    }
    .stat-order {
      border-color:#f472b6;
      background: rgba(244,114,182,0.10);
      max-width: 44vw;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .stat-order b { color:#f472b6; }

    .main-layout { display: flex; flex: 1; overflow: hidden; }
    .game-area { width: 70%; padding: 14px; overflow-y: auto; background: #0f1115; border-right: 1px solid #333; }
    .side-panel { width: 30%; background: #111; padding: 14px; display: flex; flex-direction: column; gap: 10px; overflow: hidden; }

    .grid-select { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; margin-bottom: 12px; }
    .select-btn { padding: 10px; background: #1a1a1a; border: 1px solid #444; color: #fff; border-radius: 10px; cursor: pointer; font-size: 11px; }
    .select-btn.active { border-color: #f472b6; background: rgba(244, 114, 182, 0.2); }

    .tabs { display:flex; flex-wrap: nowrap; gap: 6px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 2px; }
    .tab-btn { padding: 8px 10px; border-radius: 999px; border: 1px solid #444; background:#1a1a1a; color:#fff; cursor:pointer; font-size: 11px; white-space: nowrap; }
    .tab-btn.active { border-color:#22d3ee; background: rgba(34, 211, 238, 0.12); }

    .bottles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(115px, 1fr)); gap: 8px; }
    .bottle-card { background: #1a1a1a; padding: 8px; border-radius: 12px; text-align: center; border: 1px solid #333; }
    .pour-row { display:flex; flex-wrap:wrap; gap:4px; justify-content:center; margin-top:6px; }
    .pour-btn { background: #333; border: none; color: #22d3ee; padding: 6px 7px; font-size: 10px; cursor: pointer; border-radius: 8px; }
    .pour-btn:hover { filter: brightness(1.15); }

    .finish-btn { width: 100%; padding: 14px; border-radius: 12px; background: #10b981; color: #fff; font-weight: 900; border: none; cursor: pointer; }
    .finish-btn:disabled { opacity: 0.55; cursor: not-allowed; }

    .panel-title { font-size: 11px; color: #22d3ee; letter-spacing: 0.6px; font-weight: 900; }
    .panel-sub { font-size: 11px; color: #aab3c3; line-height: 1.35; }

    .feedback-list {
      flex: 1;
      overflow-y: auto;
      border: 1px solid #333;
      border-radius: 14px;
      padding: 10px;
      background: rgba(0,0,0,0.22);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .fb-card { border: 1px solid #2a2a2a; border-radius: 14px; padding: 10px; background: rgba(255,255,255,0.03); }
    .fb-head { display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
    .fb-name { font-weight: 900; color: #fff; font-size: 12px; }
    .fb-badge { font-size: 11px; font-weight: 900; padding: 3px 8px; border-radius: 999px; border: 1px solid #333; white-space: nowrap; }
    .badge-ok { color:#10b981; border-color:#10b981; background: rgba(16,185,129,0.12); }
    .badge-bad { color:#f472b6; border-color:#f472b6; background: rgba(244,114,182,0.12); }
    .fb-line { font-size: 11px; color:#ddd; margin-top: 6px; line-height: 1.35; }
    .fb-errs { margin-top: 6px; font-size: 11px; color:#ffb4d6; }
    .fb-errs ul { margin-top: 4px; padding-left: 18px; font-size: 11px; }
    .fb-errs li { margin-bottom: 2px; }

    .mix-box { margin-top:12px; font-size:11px; background:#222; padding:10px; border-radius:12px; border:1px solid #333; }

    .hint-overlay {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #1a1a1a; border: 2px solid #ffd700; padding: 18px; border-radius: 12px;
      z-index: 2000; display: none; white-space: pre-line;
      box-shadow: 0 0 50px rgba(0,0,0,0.9); font-size: 14px; max-width: min(860px, 94vw);
    }
    .hidden { display: none !important; }

    .controls-footer { position: fixed; bottom: 12px; left: 12px; display: flex; gap: 10px; z-index: 1001; }
    .float-btn { width: 46px; height: 46px; border-radius: 50%; background: #222; border: 1px solid #22d3ee; color: #fff; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }
    .float-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .inline-row { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .text-input {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #22d3ee;
      background: rgba(34, 211, 238, 0.08);
      color: #fff;
      font-weight: 900;
      font-size: 12px;
      outline: none;
      width: min(520px, 100%);
    }
    .mini-btn {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #22d3ee;
      background: transparent;
      color: #22d3ee;
      cursor: pointer;
      font-weight: 900;
      font-size: 12px;
      white-space: nowrap;
    }
    .mini-btn:hover { background:#22d3ee; color:#000; }

    .card { border: 1px solid #333; border-radius: 16px; background: rgba(255,255,255,0.03); padding: 12px; }
    .card-h { font-size: 13px; font-weight: 900; color:#fff; margin-bottom: 8px; }

    .training-bar {
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 10px; border-radius: 16px; border:1px solid #333;
      background: rgba(0,0,0,0.25); margin-bottom: 10px;
    }
    .training-left { display:flex; flex-direction:column; gap:4px; min-width: 140px; }
    .training-title { font-weight: 900; font-size: 13px; white-space: nowrap; overflow:hidden; text-overflow: ellipsis; max-width: 40vw; }
    .training-sub { font-size: 11px; color:#aab3c3; white-space: nowrap; }
    .training-actions { display:flex; gap:8px; flex-wrap: wrap; justify-content:flex-end; }

    .pill {
      font-size: 11px; border:1px solid #22d3ee; border-radius: 999px;
      padding: 5px 10px; background: rgba(34,211,238,0.10);
      display:inline-flex; gap:6px; align-items:center; white-space: nowrap;
    }
    .attempt-row { display:flex; gap:10px; align-items:center; flex-wrap: nowrap; overflow-x: auto; padding-bottom: 2px; }

    #screen-results { background: radial-gradient(circle, #0b1220 0%, #000 70%); }
    .results-wrap { max-width: 1060px; margin: 0 auto; padding: 24px; width: 100%; overflow-y:auto; }
    .results-card { border: 1px solid #22d3ee; border-radius: 18px; padding: 18px; background: rgba(255,255,255,0.04); }
    .results-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
    .res-box { border: 1px solid #2a2a2a; border-radius: 14px; padding: 12px; background: rgba(0,0,0,0.25); }
    .res-h { color:#22d3ee; font-weight:900; font-size:12px; margin-bottom: 6px; }
    .res-p { font-size: 12px; color:#eee; line-height: 1.45; }
    .res-list { margin-top: 6px; padding-left: 18px; font-size: 12px; color:#ddd; }
    .res-actions { display:flex; gap:10px; margin-top: 16px; flex-wrap: wrap; }
    .res-btn { padding: 12px 14px; border-radius: 12px; border: 1px solid #22d3ee; background: transparent; color:#22d3ee; cursor:pointer; font-weight: 900; }
    .res-btn:hover { background:#22d3ee; color:#000; }

    @media (max-width: 980px) { .game-area { width: 60%; } .side-panel { width: 40%; } .stat-order { max-width: 48vw; } }
    @media (max-width: 780px) {
      body { overflow:auto; }
      .main-layout { flex-direction: column; }
      .game-area, .side-panel { width: 100%; height: auto; }
      .side-panel { max-height: 44vh; }
      .results-grid { grid-template-columns: 1fr; }
      .stat-order { max-width: 62vw; }
    }
  </style>
</head>

<body>
<div class="container">
  <div id="screen-menu" class="screen active">
    <div class="menu-card">
      <h1 style="color:#22d3ee; margin-bottom:10px; letter-spacing:0.5px;">BAR MASTER PRO</h1>

      <button class="mode-btn" data-action="start" data-mode="random20">üé≤ 20 RANDOM COCKTAILS</button>
      <button class="mode-btn" data-action="start" data-mode="sprint5">‚ö° 5-MIN SPRINT</button>
      <button class="mode-btn" data-action="start" data-mode="marathon">üèÅ MARATHON (ALL)</button>
      <button class="mode-btn" data-action="start" data-mode="exam">üéì EXAM MODE (1 mistake = fail)</button>
      <button class="mode-btn" data-action="start" data-mode="memory">üß† MEMORY MODE (3√ó5)</button>
      <button class="mode-btn" data-action="start" data-mode="training">üß© TRAINING</button>
    </div>
  </div>

  <div id="screen-game" class="screen">
    <div class="header">
      <div class="header-title">üç∏ <span id="display-mode">‚Äî</span></div>
      <div class="header-right">
        <div class="stat-box" id="timer-box">‚è±Ô∏è <span id="timer">0:00</span></div>
        <div class="stat-box" id="score-box">‚≠ê <span id="score-counter">‚Äî</span></div>
        <div class="stat-box hidden" id="sprint-norm" style="border-color:#10b981; background: rgba(16,185,129,0.12);">‚ö° Norm: <b>30s</b></div>
        <div class="stat-box stat-order">
          <span id="order-label">ORDER:</span>
          <b id="order-name">---</b>
        </div>
      </div>
    </div>

    <div class="main-layout">
      <div class="game-area">
        <div id="training-screen" class="hidden">
          <div class="card" style="margin-bottom:10px">
            <div class="card-h">Training ‚Ä¢ select cocktail</div>
            <div class="inline-row">
              <select id="training-select" class="text-input" style="font-weight:900;"></select>
              <button class="mini-btn" data-action="training-load">Select</button>
            </div>
          </div>

          <div id="training-bar" class="training-bar hidden">
            <div class="training-left">
              <div class="training-title" id="training-name">‚Äî</div>
              <div class="training-sub" id="training-progress">‚Äî</div>
            </div>
            <div class="training-actions">
              <span class="pill">üéØ <b id="training-goal">12s</b></span>
              <span class="pill">üñ± <b id="training-opt">‚Äî</b></span>
              <button class="mini-btn" data-action="training-start">Start</button>
              <button class="mini-btn" data-action="training-reset">Reset</button>
            </div>
          </div>

          <div id="training-live" class="card hidden">
            <div class="attempt-row">
              <span class="pill">‚è± <b id="training-live-time">0.0s</b></span>
             <span class="pill">üéØ <b id="training-live-gap">‚Äî</b></span>
              <span class="pill">üñ± <b id="training-live-clicks">0</b></span>
              <span class="pill">üç∂ <b id="training-live-pour">0</b></span>
              <span class="pill">üìë <b id="training-live-tabs">0</b></span>
            </div>
          </div>
        </div>

        <div id="memory-box" class="hidden">
          <div class="card" style="margin-bottom:10px">
            <div class="card-h">Memory</div>
            <div class="inline-row">
              <input id="memory-input" class="text-input" placeholder="Type cocktail name..." />
              <button class="mini-btn" data-action="memory-confirm">Select order</button>
              <button class="mini-btn" data-action="memory-forgot">I forgot</button>
              <button class="mini-btn" data-action="memory-left">Left</button>
            </div>
            <div class="panel-sub" id="memory-hint">‚Äî</div>
          </div>
        </div>

        <div id="step-1">
          <h4 style="color:#22d3ee; margin-bottom:10px">STEP 1: SETUP</h4>
          <div class="grid-select" id="glass-grid"></div>
          <div class="grid-select" id="tool-grid"></div>
          <button id="btn-step-2" class="finish-btn" data-action="step" data-step="2" disabled>GO TO POUR</button>
        </div>

        <div id="step-2" class="hidden">
          <h4 style="color:#22d3ee; margin-bottom:10px">STEP 2: INGREDIENTS</h4>
          <div id="tabs-bar" class="tabs"></div>
          <div id="bottles-grid" class="bottles-grid"></div>
          <div class="mix-box">IN GLASS: <span id="current-mix">Empty</span></div>
          <button class="finish-btn" style="margin-top:10px" data-action="step" data-step="3">TO GARNISH</button>
        </div>

        <div id="step-3" class="hidden">
          <h4 style="color:#22d3ee; margin-bottom:10px">STEP 3: GARNISH</h4>
          <div class="grid-select" id="garnish-grid"></div>
        </div>
      </div>

      <div class="side-panel">
        <div class="panel-title">FEEDBACK</div>
        <div id="feedback-list" class="feedback-list">
          <div class="panel-sub">‚Äî</div>
        </div>

        <button data-action="reset-mix"
                style="padding:10px; background:#431407; border:none; color:white; border-radius:12px; cursor:pointer; font-size:11px; font-weight:900;">
          RESET BUILD
        </button>
      </div>
    </div>
  </div>

  <div id="screen-results" class="screen">
    <div class="results-wrap">
      <div class="results-card">
        <h2 style="color:#22d3ee; margin-bottom: 6px;">üèÅ Results</h2>
        <div class="panel-sub" id="results-sub">‚Äî</div>

        <div class="results-grid">
          <div class="res-box">
            <div class="res-h">‚è± Fastest</div>
            <div class="res-p" id="res-fast">‚Äî</div>
          </div>
          <div class="res-box">
            <div class="res-h">üê¢ Slowest</div>
            <div class="res-p" id="res-slow">‚Äî</div>
          </div>
          <div class="res-box">
            <div class="res-h">‚ùå Most errors</div>
            <div class="res-p" id="res-most-errors">‚Äî</div>
          </div>
          <div class="res-box">
            <div class="res-h">üìå Recommendations</div>
            <ul class="res-list" id="res-reco"></ul>
          </div>
        </div>

        <div class="res-actions">
          <button class="res-btn" data-action="back-menu">MENU</button>
          <button class="res-btn" data-action="restart">RESTART</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="hint-box" class="hint-overlay"></div>

<div class="controls-footer">
  <button class="float-btn" data-action="toggle-hint" id="hint-btn">üí°</button>
  <button class="float-btn" data-action="toggle-music">üéµ</button>
</div>

<audio id="audio-player" loop src="https://cdn.pixabay.com/audio/2022/05/27/audio_1808fbf07a.mp3"></audio>

<script>
"use strict";
/************ STORAGE ************/
const STORAGE_KEY = "barMasterPro_v1";

function loadStorage() {
  return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { best: {} };
}
function saveStorage(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

const storage = loadStorage();

function goalMsByIngredients(ingredientCount) {
  return Math.max(1, ingredientCount) * 4 * 1000; // 4s per ingredient
}

function saveAttemptResult(cocktailName, durationMs, ingredientCount) {
  const goalMs = goalMsByIngredients(ingredientCount);
  const prev = storage.best[cocktailName] || { bestTimeMs: null, attemptsMs: [] };

  // attempts: keep only last 5
  const attempts = Array.isArray(prev.attemptsMs) ? prev.attemptsMs.slice() : [];
  attempts.push(durationMs);
  const last5 = attempts.slice(-5);

  const avgLast5Ms = last5.reduce((a,b)=>a+b, 0) / Math.max(1, last5.length);
  const learned = avgLast5Ms <= goalMs;

  const bestTimeMs = (prev.bestTimeMs == null) ? durationMs : Math.min(prev.bestTimeMs, durationMs);

  storage.best[cocktailName] = {
    bestTimeMs,
    attemptsMs: last5,
    avgLast5Ms,
    learned,
    goalMs
  };

  saveStorage(storage);
}

function getCocktailProgress(name) {
  const p = storage.best[name];
  if (!p) return null;
  const attempts = Array.isArray(p.attemptsMs) ? p.attemptsMs : [];
  return {
    bestTimeMs: p.bestTimeMs ?? null,
    avgLast5Ms: p.avgLast5Ms ?? null,
    learned: !!p.learned,
    attemptsCount: attempts.length,
    goalMs: p.goalMs ?? null
  };
}// training select
    
/** Settings */
const VOLUME_TOLERANCE_ML = 5;
const SPRINT_SECONDS = 300;
const SPRINT_NORM_SEC = 30;
const SPRINT_OVER_PENALTY_PER_SEC = 0.5;

const MEMORY_ROUNDS = 3;
const MEMORY_PER_ROUND = 5;
const MEMORY_REVEAL_MS = 2500;

/** Allowed garnishes (English only, MUST match buttons) */
const ALLOWED_GARNISHES = [
  "None",
  "Powdered sugar",
  "Orange slice",
  "Orange twist",
  "Lemon twist",
  "Lemon wheel",
  "Lemon spiral",
  "Lime wheel",
  "Lime wedge",
  "Lime twist",
  "Mint sprig",
  "Raspberry",
  "Maraschino cherry",
  "Cherry",
  "Olive",
  "Pineapple wedge",
  "Nutmeg",
  "Chocolate shavings",
  "Coffee beans",
  "Sugar rim",
  "Angostura bitters",
  "Optional mint leaf"
];

/** UI selections */
const ui = {
  glasses: [
    "Shot",
    "Highball",
    "Rocks",
    "Coupe",
    "Cocktail",
    "Martini",
    "Flute",
    "Irish Coffee"
  ],
  tools: [
    "Build",
    "Build (layers)",
    "Build, muddle",
    "Muddle, build",
    "Build, rinse",
    "Stir",
    "Shake",
    "Shake (dry, wet)",
    "Shake, top",
    "Shake (dry, wet), top"
  ]
};

/**
 * Ingredient unit meta:
 * - ml: uses +1/+5/+10/+20
 * - dash/tsp/egg/piece/rinse: uses +1 only
 */
const ingredientMeta = {
    
  "Egg White": { unit: "egg" },
  "Egg Yolk": { unit: "egg" },
  "Lime": { unit: "piece" },
  "Sugar (tsp)": { unit: "tsp" },

  "Angostura": { unit: "dash" },
  "Orange Bitters": { unit: "dash" },
  "Orange Flower Water": { unit: "dash" },
  "Vanilla Bitters": { unit: "dash" },
  "Absinthe (dashes)": { unit: "dash" },

  "Absinthe (rinse)": { unit: "rinse" }
};
    
const INGREDIENT_ALIASES = {
  "Kahlua": "Coffee Liqueur",
  "Cointreau": "Triple Sec",
};

/** Ingredient catalog */
const ingredients = {
  "Spirits": [
    "Gin",
    "Vodka",
    "Rum",
    "White Rum",
    "Dark Rum",
    "Cognac",
    "Bourbon",
    "Rye Whiskey",
    "Scotch Whisky",
    "Irish Whiskey",
    "Tequila",
    "Cachaca",
    "Pisco"
  ],
  "Fortified / Wine": [
    "Dry Vermouth",
    "Sweet Vermouth",
    "Lillet Blanc",
    "Port Wine",
    "Prosecco",
    "Champagne",
    "Sparkling Wine"
  ],
  "Liqueurs": [
    "Campari",
    "Triple Sec",
    "Cointreau",
    "Baileys",
    "Coffee Liqueur",
    "Kahlua",
    "Maraschino",
    "Creme de Violette",
    "Creme de Cacao",
    "Creme de Cacao (White)",
    "Green Mint Liqueur",
    "Creme de Menthe (Green)",
    "Fernet-Branca",
    "Green Chartreuse",
    "Drambuie",
    "Southern Comfort",
    "Amaretto",
    "Apricot Brandy",
    "Calvados",
    "Chambord",
    "Blue Curacao",
    "Creme de Cassis",
    "Absinthe"
  ],
  "Juice / Mixers": [
    "Lemon Juice",
    "Lime Juice",
    "Orange Juice",
    "Pineapple Juice",
    "Grapefruit Juice",
    "Cranberry Juice",
    "Soda",
    "Ginger Beer",
    "Cola",
    "Lemonade",
    "Espresso",
    "Hot Coffee",
    "Water"
  ],
  "Sweeteners": [
    "Simple Syrup",
    "Grenadine",
    "Sugar",
    "Sugar (tsp)",
    "Raspberry Syrup"
  ],
  "Dairy / Puree": [
    "Cream",
    "Fresh Cream",
    "Peach Puree"
  ],
  "Bitters / Aromatics": [
    "Angostura",
    "Orange Bitters",
    "Orange Flower Water",
    "Vanilla Bitters",
    "Absinthe (dashes)",
    "Absinthe (rinse)"
  ],
  "Other": [
    "Mint Liqueur"
  ]
};

/** Recipes (your list, normalized to English + arrays) */
const recipes = {
  "Alexander": { ing: { "Gin": 30, "Creme de Cacao": 30, "Cream": 30 }, glass: "Coupe", tool: "Shake", garnishes: ["Powdered sugar"] },
  "Americano": { ing: { "Campari": 30, "Sweet Vermouth": 30, "Soda": 60 }, glass: "Highball", tool: "Build", garnishes: ["Orange slice"] },
  "B-52": { ing: { "Coffee Liqueur": 20, "Baileys": 20, "Triple Sec": 20 }, glass: "Shot", tool: "Build (layers)", garnishes: ["None"] },
  "Between the Sheets": { ing: { "Rum": 30, "Cognac": 30, "Triple Sec": 15, "Lemon Juice": 15 }, glass: "Coupe", tool: "Shake", garnishes: ["Lemon twist"] },
  "Casino": { ing: { "Gin": 40, "Maraschino": 10, "Lemon Juice": 15, "Orange Bitters": 2 }, glass: "Coupe", tool: "Shake", garnishes: ["Maraschino cherry"] },
  "Clover Club": { ing: { "Gin": 45, "Raspberry Syrup": 15, "Lemon Juice": 15, "Egg White": 1 }, glass: "Coupe", tool: "Shake (dry, wet)", garnishes: ["Raspberry"] },
  "Daiquiri": { ing: { "White Rum": 50, "Lime Juice": 20, "Simple Syrup": 15 }, glass: "Coupe", tool: "Shake", garnishes: ["Lime wheel"] },
  "Derby": { ing: { "Gin": 60, "Mint Liqueur": 10, "Orange Bitters": 2 }, glass: "Cocktail", tool: "Stir", garnishes: ["Mint sprig"] },
  "Dry Martini": { ing: { "Gin": 60, "Dry Vermouth": 10 }, glass: "Martini", tool: "Stir", garnishes: ["Olive", "Lemon twist"] },
  "Gin Fizz": { ing: { "Gin": 45, "Simple Syrup": 15, "Lemon Juice": 20, "Soda": 90, "Egg White": 1 }, glass: "Highball", tool: "Shake, top", garnishes: ["Lemon wheel"] },
  "Grasshopper": { ing: { "Green Mint Liqueur": 30, "Creme de Cacao": 30, "Cream": 30 }, glass: "Coupe", tool: "Shake", garnishes: ["Chocolate shavings"] },
  "Hanky Panky": { ing: { "Gin": 30, "Sweet Vermouth": 30, "Fernet-Branca": 10 }, glass: "Coupe", tool: "Stir", garnishes: ["Orange twist"] },
  "John Collins": { ing: { "Gin": 45, "Lemon Juice": 25, "Simple Syrup": 20, "Soda": 90 }, glass: "Highball", tool: "Build", garnishes: ["Orange slice", "Cherry"] },
  "Last Word": { ing: { "Gin": 20, "Green Chartreuse": 20, "Maraschino": 20, "Lime Juice": 20 }, glass: "Coupe", tool: "Shake", garnishes: ["Lime twist"] },
  "Manhattan": { ing: { "Rye Whiskey": 50, "Sweet Vermouth": 20, "Angostura": 2 }, glass: "Coupe", tool: "Stir", garnishes: ["Cherry"] },
  "Mary Pickford": { ing: { "White Rum": 45, "Pineapple Juice": 45, "Maraschino": 15, "Grenadine": 5, "Lime Juice": 10 }, glass: "Coupe", tool: "Shake", garnishes: ["Pineapple wedge"] },
  "Monkey Gland": { ing: { "Gin": 45, "Orange Juice": 15, "Grenadine": 15, "Absinthe": 5 }, glass: "Coupe", tool: "Shake", garnishes: ["Orange twist"] },
  "Negroni": { ing: { "Gin": 30, "Campari": 30, "Sweet Vermouth": 30 }, glass: "Rocks", tool: "Stir", garnishes: ["Orange twist"] },
  "Old Fashioned": { ing: { "Bourbon": 50, "Sugar": 10, "Angostura": 3, "Water": 10 }, glass: "Rocks", tool: "Build, muddle", garnishes: ["Orange twist"] },
  "Paradise": { ing: { "Gin": 30, "Apricot Brandy": 15, "Pineapple Juice": 45 }, glass: "Coupe", tool: "Shake", garnishes: ["Pineapple wedge"] },
  "Planter's Punch": { ing: { "Dark Rum": 45, "Orange Juice": 30, "Lemon Juice": 20, "Simple Syrup": 15, "Grenadine": 10 }, glass: "Highball", tool: "Shake", garnishes: ["Orange slice", "Cherry"] },
  "Porto Flip": { ing: { "Cognac": 35, "Port Wine": 35, "Egg Yolk": 1 }, glass: "Coupe", tool: "Shake", garnishes: ["Nutmeg"] },
  "Ramos Gin Fizz": { ing: { "Gin": 45, "Cream": 30, "Lemon Juice": 15, "Lime Juice": 15, "Simple Syrup": 20, "Orange Flower Water": 3, "Vanilla Bitters": 3, "Egg White": 1, "Soda": 90 }, glass: "Highball", tool: "Shake (dry, wet), top", garnishes: ["None"] },
  "Rusty Nail": { ing: { "Scotch Whisky": 50, "Drambuie": 25 }, glass: "Rocks", tool: "Build", garnishes: ["Lemon twist"] },
  "Sazerac": { ing: { "Rye Whiskey": 60, "Sugar": 10, "Angostura": 3, "Absinthe (rinse)": 1 }, glass: "Rocks", tool: "Build, rinse", garnishes: ["Lemon twist"] },
  "Sidecar": { ing: { "Cognac": 50, "Triple Sec": 20, "Lemon Juice": 20 }, glass: "Coupe", tool: "Shake", garnishes: ["Sugar rim", "Lemon twist"] },

  "Adventure": { ing: { "Gin": 45, "Maraschino": 15, "Grenadine": 10, "Lemon Juice": 15 }, glass: "Coupe", tool: "Shake", garnishes: ["Maraschino cherry"] },
  "Affinity": {
  ing: {
    "Scotch Whisky": 50,
    "Dry Vermouth": 25,
    "Sweet Vermouth": 15,
    "Orange Bitters": 2
  },
  glass: "Coupe",
  tool: "Stir",
  garnishes: ["Lemon twist"],

  iba: {
    status: "active",          // active | removed | never
    category: "Contemporary Classics"
  },

  hint: {
    memory: "Affinity ‚âà Infinity (‚àû): whisky + dry + sweet. Think Rob Roy with two vermouths.",
    story: "Affinity belongs to the Manhattan / Rob Roy family, but uses both dry and sweet vermouth for balance.",
    sequence: "Glass ‚Üí Whisky ‚Üí Dry Vermouth ‚Üí Sweet Vermouth ‚Üí Bitters ‚Üí Stir ‚Üí Strain ‚Üí Lemon twist.",
    speed: "Pour both vermouths back-to-back. Bitters last. Stir only.",
    commonMistakes: "Turning it into Rob Roy (only sweet vermouth). Forgetting bitters."
  }
},
  "Alabama Slammer": {
  ing: {
    "Southern Comfort": 25,
    "Amaretto": 25,
    "Sloe Gin": 25,
    "Orange Juice": 120
  },
  glass: "Highball",
  tool: "Build",
  garnishes: ["None"],

  iba: {
    status: "removed",
    category: "New Era",
    note: "Removed from IBA list (pre-2020)"
  },

  hint: {
    memory: "Old IBA = SoCo + Amaretto + Sloe Gin + OJ.",
    story: "Originally listed by IBA, later removed as a party-style drink.",
    commonMistakes: "Modern bar versions with soda or grenadine are not IBA."
  }
},
  "Amaretto Sour": { ing: { "Amaretto": 45, "Lemon Juice": 25, "Egg White": 1, "Soda": 30 }, glass: "Rocks", tool: "Shake, top", garnishes: ["Cherry"] },
  "Angel Face": { ing: { "Gin": 30, "Calvados": 30, "Apricot Brandy": 30 }, glass: "Coupe", tool: "Stir", garnishes: ["Orange twist"] },
  "Aviation": { ing: { "Gin": 45, "Maraschino": 10, "Lemon Juice": 15, "Creme de Violette": 10 }, glass: "Coupe", tool: "Shake", garnishes: ["Maraschino cherry"] },
  "Bacardi": { ing: { "White Rum": 50, "Lime Juice": 20, "Simple Syrup": 10, "Grenadine": 5 }, glass: "Coupe", tool: "Shake", garnishes: ["Lemon twist"] },
  "Balalaika": { ing: { "Vodka": 40, "Cointreau": 20, "Lime Juice": 20 }, glass: "Coupe", tool: "Shake", garnishes: ["Lime twist"] },
  "Bellini": { ing: { "Peach Puree": 50, "Prosecco": 100 }, glass: "Flute", tool: "Build", garnishes: ["None"] },
  "Blue Lagoon": { ing: { "Vodka": 30, "Blue Curacao": 30, "Lemonade": 120 }, glass: "Highball", tool: "Build", garnishes: ["Orange slice"] },
  "Boulevardier": { ing: { "Bourbon": 45, "Campari": 30, "Sweet Vermouth": 30 }, glass: "Rocks", tool: "Stir", garnishes: ["Orange twist"] },
  "Bronx": { ing: { "Gin": 45, "Sweet Vermouth": 15, "Dry Vermouth": 15, "Orange Juice": 30 }, glass: "Coupe", tool: "Shake", garnishes: ["Orange twist"] },
  "Caipirinha": { ing: { "Cachaca": 50, "Lime": 1, "Sugar (tsp)": 3 }, glass: "Rocks", tool: "Muddle, build", garnishes: ["Lime wedge"] },
  "Caipiroska": { ing: { "Vodka": 50, "Lime": 1, "Sugar (tsp)": 3 }, glass: "Rocks", tool: "Muddle, build", garnishes: ["Lime wedge"] },
  "Corpse Reviver #2": { ing: { "Gin": 30, "Cointreau": 30, "Lillet Blanc": 30, "Absinthe (dashes)": 5, "Lemon Juice": 30 }, glass: "Coupe", tool: "Shake", garnishes: ["Cherry"] },
  "Cosmopolitan": { ing: { "Vodka": 40, "Cointreau": 20, "Cranberry Juice": 30, "Lime Juice": 15 }, glass: "Martini", tool: "Shake", garnishes: ["Lime twist"] },
  "Cuba Libre": { ing: { "White Rum": 50, "Lime Juice": 20, "Cola": 120 }, glass: "Highball", tool: "Build", garnishes: ["Lime wedge"] },

  "Dark 'n' Stormy": { ing: { "Dark Rum": 60, "Ginger Beer": 120, "Lime Juice": 20 }, glass: "Highball", tool: "Build", garnishes: ["Lime wedge"] },
  "Espresso Martini": { ing: { "Vodka": 50, "Coffee Liqueur": 20, "Espresso": 30, "Simple Syrup": 10 }, glass: "Martini", tool: "Shake", garnishes: ["Coffee beans"] },
  "French 75": { ing: { "Gin": 30, "Lemon Juice": 15, "Simple Syrup": 10, "Champagne": 60 }, glass: "Flute", tool: "Shake, top", garnishes: ["Lemon twist"] },
  "French Martini": { ing: { "Vodka": 45, "Chambord": 15, "Pineapple Juice": 30 }, glass: "Martini", tool: "Shake", garnishes: ["Raspberry"] },
  "Godfather": { ing: { "Scotch Whisky": 50, "Amaretto": 20 }, glass: "Rocks", tool: "Build", garnishes: ["None"] },
  "Hemingway Special": { ing: { "White Rum": 40, "Maraschino": 10, "Grapefruit Juice": 20, "Lime Juice": 15 }, glass: "Highball", tool: "Shake", garnishes: ["None"] },
  "Horse's Neck": { ing: { "Bourbon": 50, "Ginger Beer": 120, "Lemon Juice": 10 }, glass: "Highball", tool: "Build", garnishes: ["Lemon spiral"] },
  "Irish Coffee": { ing: { "Irish Whiskey": 45, "Hot Coffee": 120, "Simple Syrup": 15, "Cream": 30 }, glass: "Irish Coffee", tool: "Build", garnishes: ["None"] },
  "Kamikaze": { ing: { "Vodka": 30, "Triple Sec": 30, "Lime Juice": 30 }, glass: "Coupe", tool: "Shake", garnishes: ["Lime twist"] },
  "Kir Royale": { ing: { "Creme de Cassis": 10, "Sparkling Wine": 90 }, glass: "Flute", tool: "Build", garnishes: ["Lemon twist"] },
  "Lemon Drop Martini": { ing: { "Vodka": 50, "Triple Sec": 20, "Lemon Juice": 25 }, glass: "Martini", tool: "Shake", garnishes: ["Sugar rim"] },
  "Pisco Sour": { ing: { "Pisco": 60, "Lemon Juice": 30, "Simple Syrup": 20, "Egg White": 1, "Angostura": 2 }, glass: "Coupe", tool: "Shake", garnishes: ["Angostura bitters"] },
  "Tequila Sunrise": { ing: { "Tequila": 50, "Orange Juice": 120, "Grenadine": 15 }, glass: "Highball", tool: "Build", garnishes: ["Orange slice", "Cherry"] },
  "Vesper": { ing: { "Gin": 60, "Vodka": 15, "Lillet Blanc": 30 }, glass: "Martini", tool: "Stir", garnishes: ["Lemon twist"] },
  "White Russian": { ing: { "Vodka": 50, "Kahlua": 20, "Cream": 30 }, glass: "Rocks", tool: "Build", garnishes: ["None"] },

  "Grasshopper (Alt)": { ing: { "Creme de Cacao (White)": 20, "Creme de Menthe (Green)": 20, "Fresh Cream": 20 }, glass: "Coupe", tool: "Shake", garnishes: ["Optional mint leaf"] }
};

/** Game modes */
const GAME_MODES = {
  random20: { label:"üé≤ RANDOM 20", showHints:true, timed:false, durationSec:0, failOnError:false },
  sprint5:  { label:"‚ö° SPRINT 5:00", showHints:true, timed:true,  durationSec:SPRINT_SECONDS, failOnError:false },
  marathon: { label:"üèÅ MARATHON", showHints:true, timed:false, durationSec:0, failOnError:false },
  exam:     { label:"üéì EXAM", showHints:false, timed:false, durationSec:0, failOnError:true },
  memory:   { label:"üß† MEMORY", showHints:true, timed:false, durationSec:0, failOnError:false },
  training: { label:"üß© TRAINING", showHints:true, timed:false, durationSec:0, failOnError:false }
};

const state = {
  modeId: "",
  mode: null,
  interval: null,
  finished: false,

  timeLeft: 0,
  gameStartTs: 0,

  orders: [],
  currentIdx: 0,
  score: 0,

  build: { ing: {}, glass: "", tool: "" },
  orderStartTs: 0,

  hintUsesByKey: new Map(),
  results: [],
  lastModeId: null,

  // training
  trainingName: null,
  trainingRepGoal: 5,
  trainingRepDone: 0,
  trainingBestMs: null,
  trainingAttemptActive: false,
  trainingAttemptStartTs: 0,
  trainingMetrics: null,
  trainingOpt: null,
  trainingLiveTimer: null,

  // memory
  memoryQueue: [],
  memoryActiveKey: null,

  headerTimer: null
};

const $ = (id) => document.getElementById(id);

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function fmtTimeSec(totalSec) {
  const m = Math.floor(totalSec / 60);
  const s = totalSec % 60;
  return `${m}:${s < 10 ? "0" : ""}${s}`;
}

function fmtDurationMs(ms) {
  const sec = Math.max(0, Math.round(ms / 1000));
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  if (m <= 0) return `${sec}s`;
  return `${m}m ${s < 10 ? "0" : ""}${s}s`;
}

function stopHeaderTimer() {
  if (state.headerTimer) clearInterval(state.headerTimer);
  state.headerTimer = null;
}

function startHeaderTimer(getElapsedMs) {
  stopHeaderTimer();
  state.headerTimer = setInterval(() => {
    const sec = Math.max(0, Math.floor(getElapsedMs() / 1000));
    $("timer").textContent = fmtTimeSec(sec);
  }, 200);
}

function toggleMusic() {
  const p = $("audio-player");
  if (p.paused) p.play().catch(() => alert("Click once to enable audio"));
  else p.pause();
}

function showScreen(id) {
  ["screen-menu","screen-game","screen-results"].forEach(s => $(s).classList.remove("active"));
  $(id).classList.add("active");
}

function incHintUse(key) {
  state.hintUsesByKey.set(key, (state.hintUsesByKey.get(key) || 0) + 1);
}
function getHintUses(key) {
  return state.hintUsesByKey.get(key) || 0;
}

function normalizeToArrayGarnish(g) {
  if (!g) return ["None"];
  if (Array.isArray(g)) return g;
  if (typeof g === "string") {
    const raw = g.trim();
    if (!raw) return ["None"];
    if (raw.toLowerCase() === "no") return ["None"];
    if (raw.includes(",")) return raw.split(",").map(x => x.trim()).filter(Boolean);
    if (raw.includes(" or ")) return raw.split(" or ").map(x => x.trim()).filter(Boolean);
    return [raw];
  }
  return ["None"];
}

/** Double-check + auto-fix without losing recipes */
function dataIntegrityCheckAndFix() {
  // Normalize garnishes and ensure allowed
  for (const [name, r] of Object.entries(recipes)) {
    r.garnishes = normalizeToArrayGarnish(r.garnishes).map(x => x === "NO" ? "None" : x);
    r.garnishes = r.garnishes.map(g => (ALLOWED_GARNISHES.includes(g) ? g : "None"));
    if (!r.garnishes.length) r.garnishes = ["None"];

    if (!ui.glasses.includes(r.glass)) console.warn(`[missing glass] ${name}: ${r.glass}`);
    if (!ui.tools.includes(r.tool)) console.warn(`[missing tool] ${name}: ${r.tool}`);
  }

  const allIng = new Set(Object.values(ingredients).flat());
  for (const [name, r] of Object.entries(recipes)) {
    for (const ing of Object.keys(r.ing || {})) {
      if (!allIng.has(ing)) {
        console.warn(`[missing ingredient in catalog] ${name}: "${ing}" -> added to Other`);
        ingredients["Other"].push(ing);
        allIng.add(ing);
      }
    }
  }

  // Audit garnishes
  for (const [name, r] of Object.entries(recipes)) {
    for (const g of r.garnishes) {
      if (!ALLOWED_GARNISHES.includes(g)) console.warn(`[missing garnish] ${name}: "${g}"`);
    }
  }
}

function auditData() {
  const allIngredients = new Set(Object.values(ingredients).flat());
  const missingIngredients = new Map();
  const missingGlasses = new Map();
  const missingTools = new Map();
  const missingGarnishes = new Map();

  for (const [name, r] of Object.entries(recipes)) {
    for (const ing of Object.keys(r.ing || {})) {
      if (!allIngredients.has(ing)) {
        if (!missingIngredients.has(name)) missingIngredients.set(name, []);
        missingIngredients.get(name).push(ing);
      }
    }
    if (r.glass && !ui.glasses.includes(r.glass)) missingGlasses.set(name, r.glass);
    if (r.tool && !ui.tools.includes(r.tool)) missingTools.set(name, r.tool);
    for (const g of (r.garnishes || [])) {
      if (g && !ALLOWED_GARNISHES.includes(g)) {
        if (!missingGarnishes.has(name)) missingGarnishes.set(name, []);
        missingGarnishes.get(name).push(g);
      }
    }
  }

  console.log("AUDIT missing ingredients by cocktail:", Object.fromEntries(missingIngredients));
  console.log("AUDIT missing glasses by cocktail:", Object.fromEntries(missingGlasses));
  console.log("AUDIT missing tools by cocktail:", Object.fromEntries(missingTools));
  console.log("AUDIT missing garnishes by cocktail:", Object.fromEntries(missingGarnishes));
}

function updateStep2Lock() {
  $("btn-step-2").disabled = !(state.build.glass && state.build.tool);
}

function resetMix() {
  state.build = { ing: {}, glass: "", tool: "" };
  $("current-mix").innerText = "Empty";
  $("glass-grid").querySelectorAll(".select-btn").forEach(b => b.classList.remove("active"));
  $("tool-grid").querySelectorAll(".select-btn").forEach(b => b.classList.remove("active"));
  updateStep2Lock();
}

function changeStep(stepNum) {
  ["step-1","step-2","step-3"].forEach(id => $(id).classList.add("hidden"));
  $(`step-${stepNum}`).classList.remove("hidden");
}

function addIng(name, amt) {
  const canonical = INGREDIENT_ALIASES[name] || name;
  state.build.ing[canonical] = (state.build.ing[canonical] || 0) + amt;

  const parts = Object.entries(state.build.ing).map(([i, vol]) => `${i}(${vol})`);
  $("current-mix").innerText = parts.length ? parts.join(", ") : "Empty";
}

function selectAttr(key, value, btnEl) {
  state.build[key] = value;
  const container = key === "glass" ? $("glass-grid") : $("tool-grid");
  container.querySelectorAll(".select-btn").forEach(b => b.classList.remove("active"));
  btnEl.classList.add("active");
  updateStep2Lock();
}

function renderStaticUI() {
  // glasses
  $("glass-grid").innerHTML = ui.glasses.map(g =>
    `<button class="select-btn" data-action="select-attr" data-key="glass" data-value="${escapeHtml(g)}">${escapeHtml(g)}</button>`
  ).join("");

  // tools
  $("tool-grid").innerHTML = ui.tools.map(t =>
    `<button class="select-btn" data-action="select-attr" data-key="tool" data-value="${escapeHtml(t)}">${escapeHtml(t)}</button>`
  ).join("");

  // garnishes (submit)
  $("garnish-grid").innerHTML = ALLOWED_GARNISHES.map(g =>
    `<button class="select-btn" data-action="submit" data-garnish="${escapeHtml(g)}">${escapeHtml(g)}</button>`
  ).join("");

  // tabs
  const tabs = Object.keys(ingredients);
  $("tabs-bar").innerHTML = tabs.map((cat, idx) =>
    `<button class="tab-btn ${idx === 0 ? "active" : ""}" data-action="tab" data-cat="${escapeHtml(cat)}">${escapeHtml(cat)}</button>`
  ).join("");
  renderBottles(tabs[0]);
  updateStep2Lock();

   // training select
    const sel = $("training-select");
  sel.innerHTML = Object.keys(recipes)
    .sort((a,b)=>a.localeCompare(b))
    .map(n => {
      const ingCount = Object.keys(recipes[n].ing).length;
      const goalMs = goalMsByIngredients(ingCount);
      const p = getCocktailProgress(n);

      const icon = p ? (p.learned ? "üèÜ " : "‚è≥ ") : "üÜï ";
      const avgTxt = p && p.avgLast5Ms != null ? ` ‚Ä¢ avg5 ${(p.avgLast5Ms/1000).toFixed(1)}s` : "";
      const goalTxt = ` ‚Ä¢ goal ${(goalMs/1000).toFixed(0)}s`;

      return `<option value="${escapeHtml(n)}">${escapeHtml(icon + n + goalTxt + avgTxt)}</option>`;
    })
    .join("");
}


function renderBottles(cat) {
  const list = (ingredients[cat] || []);
  $("bottles-grid").innerHTML = list.map(ing => {
    const unit = ingredientMeta[ing]?.unit || "ml";
    const amts = unit === "ml" ? [1,5,10,20] : [1];
    const buttons = amts.map(a => {
      const label = unit === "ml" ? `+${a}ml` : `+${a}`;
      return `<button class="pour-btn" data-action="pour" data-ing="${escapeHtml(ing)}" data-amt="${a}">${label}</button>`;
    }).join("");
    return `
      <div class="bottle-card">
        <div style="font-size:10px; min-height:24px; overflow:hidden">${escapeHtml(ing)}</div>
        <div class="pour-row">${buttons}</div>
      </div>
    `;
  }).join("");
}

function escapeHtml(s) {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}

function getIngredientCategory(ing) {
  for (const [cat, items] of Object.entries(ingredients)) if (items.includes(ing)) return cat;
  return "Other";
}

const POUR_STEPS = [20,10,5,1];
function minPourClicksForMlWithTolerance(targetMl) {
  const lo = Math.max(0, targetMl - VOLUME_TOLERANCE_ML);
  const hi = targetMl + VOLUME_TOLERANCE_ML;
  let best = Infinity;
  const maxClicks = 10;

  function dfs(sum, clicks) {
    if (clicks >= best) return;
    if (sum >= lo && sum <= hi) { best = clicks; return; }
    if (sum > hi) return;
    if (clicks >= maxClicks) return;
    for (const step of POUR_STEPS) dfs(sum + step, clicks + 1);
  }
  dfs(0, 0);
  return best === Infinity ? maxClicks : best;
}

function computeOptimalForCocktail(name) {
  const r = recipes[name];
  const neededCats = new Set();
  let optPour = 0;

  for (const [ing, expected] of Object.entries(r.ing)) {
    const unit = ingredientMeta[ing]?.unit || "ml";
    if (unit === "ml") optPour += minPourClicksForMlWithTolerance(expected);
    else optPour += expected;
    neededCats.add(getIngredientCategory(ing));
  }

  const tabs = Object.keys(ingredients);
  const defaultTab = tabs[0];
  const distinct = neededCats.size;
  const optTabs = distinct <= 1 ? (neededCats.has(defaultTab) ? 0 : (distinct === 0 ? 0 : 1))
                                : (neededCats.has(defaultTab) ? (distinct - 1) : distinct);

  const optTotal = 1 + 1 + 2 + optTabs + optPour + 1;
  return { optPour, optTabs, optTotal };
}

function validateBuild(target, garnishPicked) {
  const errs = [];
  const b = state.build;

  if (b.glass !== target.glass) errs.push({ type:"glass", msg:`Glass (need ${target.glass})` });
  if (b.tool !== target.tool) errs.push({ type:"tool", msg:`Method (need ${target.tool})` });
  if (!target.garnishes.includes(garnishPicked)) errs.push({ type:"garnish", msg:`Garnish (need ${target.garnishes.join(" or ")})` });

  for (const [ing, expected] of Object.entries(target.ing)) {
    const actual = b.ing[ing] || 0;
    const unit = ingredientMeta[ing]?.unit || "ml";

    if (unit === "ml") {
      if (Math.abs(actual - expected) > VOLUME_TOLERANCE_ML) errs.push({ type:"volume", msg:`${ing}: ${actual}/${expected}ml (¬±${VOLUME_TOLERANCE_ML})` });
    } else {
      if (actual !== expected) errs.push({ type:"volume", msg:`${ing}: ${actual}/${expected}` });
    }
  }

  for (const ing of Object.keys(b.ing)) {
    if (!(ing in target.ing)) errs.push({ type:"extra", msg:`Extra ingredient: ${ing}` });
  }

  return errs;
}

function computeQuality(errs) {
  let q = 100;
  const c = errs.reduce((m, e) => (m[e.type] = (m[e.type] || 0) + 1, m), {});
  q -= (c.volume || 0) * 5;
  q -= (c.extra || 0) * 5;
  if (c.tool) q -= 10;
  if (c.glass) q -= 10;
  if (c.garnish) q -= 10;
  return Math.max(0, Math.round(q));
}

function applySprintTimePenalty(quality, durationMs) {
  if (state.modeId !== "sprint5") return quality;
  const sec = Math.round(durationMs / 1000);
  if (sec <= SPRINT_NORM_SEC) return quality;
  const over = sec - SPRINT_NORM_SEC;
  return Math.max(0, Math.round(quality - over * SPRINT_OVER_PENALTY_PER_SEC));
}

function appendFeedbackCard({ title, ok, lines, errors, hintUses }) {
  const list = $("feedback-list");
  const first = list.firstElementChild;
  if (first && first.classList.contains("panel-sub")) list.removeChild(first);

  const card = document.createElement("div");
  card.className = "fb-card";

  const head = document.createElement("div");
  head.className = "fb-head";

  const nm = document.createElement("div");
  nm.className = "fb-name";
  nm.textContent = title;

  const badge = document.createElement("div");
  badge.className = `fb-badge ${ok ? "badge-ok" : "badge-bad"}`;
  badge.textContent = ok ? "‚úÖ OK" : "‚ùå Errors";

  head.appendChild(nm);
  head.appendChild(badge);
  card.appendChild(head);

  for (const l of (lines || [])) {
    const d = document.createElement("div");
    d.className = "fb-line";
    d.textContent = l;
    card.appendChild(d);
  }

  const hu = document.createElement("div");
  hu.className = "fb-line";
  hu.textContent = `üí° Hints used: ${hintUses ?? 0}`;
  card.appendChild(hu);

  if (errors?.length) {
    const errsEl = document.createElement("div");
    errsEl.className = "fb-errs";
    errsEl.textContent = "Errors:";
    const ul = document.createElement("ul");
    for (const msg of errors) {
      const li = document.createElement("li");
      li.textContent = msg;
      ul.appendChild(li);
    }
    errsEl.appendChild(ul);
    card.appendChild(errsEl);
  }

  list.appendChild(card);
  list.scrollTop = list.scrollHeight;
}

function buildHintText(name) {
  const r = recipes[name];
  const lines = [];
  lines.push(`RECIPE: ${name}\n`);
  for (const [ing, val] of Object.entries(r.ing)) {
    const unit = ingredientMeta[ing]?.unit || "ml";
    if (unit === "ml") lines.push(`‚Ä¢ ${ing}: ${val} ml`);
    else if (unit === "dash") lines.push(`‚Ä¢ ${ing}: ${val} dashes`);
    else if (unit === "tsp") lines.push(`‚Ä¢ ${ing}: ${val} tsp`);
    else if (unit === "egg") lines.push(`‚Ä¢ ${ing}: ${val}`);
    else if (unit === "piece") lines.push(`‚Ä¢ ${ing}: ${val}`);
    else if (unit === "rinse") lines.push(`‚Ä¢ ${ing}: rinse`);
    else lines.push(`‚Ä¢ ${ing}: ${val}`);
  }
  lines.push(`\nGlass: ${r.glass}`);
  lines.push(`Method: ${r.tool}`);
  lines.push(`Garnish: ${r.garnishes.join(" or ")}`);

  // ===== Extended hint blocks =====
  if (r.hint) {
    if (r.hint.memory) lines.push(`\nüß† MEMORY:\n${r.hint.memory}`);
    if (r.hint.story) lines.push(`\nüìö STORY:\n${r.hint.story}`);
    if (r.hint.sequence) lines.push(`\n‚öôÔ∏è SEQUENCE:\n${r.hint.sequence}`);
    if (r.hint.speed) lines.push(`\n‚ö° SPEED TIP:\n${r.hint.speed}`);
    if (r.hint.commonMistakes) lines.push(`\n‚ùó COMMON MISTAKES:\n${r.hint.commonMistakes}`);
  }

  return lines.join("\n");
}

function toggleHint() {
  if (!state.mode?.showHints) return;
  const h = $("hint-box");
  const willOpen = h.style.display !== "block";

  const key =
    state.modeId === "training" ? state.trainingName :
    state.modeId === "memory" ? state.memoryActiveKey :
    $("order-name").textContent;

  if (!key || !recipes[key]) return;

  if (willOpen) {
    incHintUse(key);
    h.textContent = buildHintText(key);
  }
  h.style.display = willOpen ? "block" : "none";
}

function setupModeUI(modeId) {
  state.modeId = modeId;
  state.mode = GAME_MODES[modeId];
  state.lastModeId = modeId;
  state.finished = false;

  $("training-screen").classList.toggle("hidden", modeId !== "training");
  $("memory-box").classList.toggle("hidden", modeId !== "memory");

  $("display-mode").textContent = state.mode.label;
  $("sprint-norm").classList.toggle("hidden", modeId !== "sprint5");
  $("hint-btn").disabled = !state.mode.showHints;

  $("feedback-list").innerHTML = `<div class="panel-sub">‚Äî</div>`;

  stopHeaderTimer();
  if (state.interval) clearInterval(state.interval);
  state.interval = null;

  if (state.mode.timed) {
    state.timeLeft = state.mode.durationSec;
    $("timer").textContent = fmtTimeSec(state.timeLeft);
    state.interval = setInterval(() => {
      if (state.finished) return;
      state.timeLeft -= 1;
      $("timer").textContent = fmtTimeSec(Math.max(0, state.timeLeft));
      if (state.timeLeft <= 0) finishGame("Time is up!");
    }, 1000);
  } else {
    state.gameStartTs = Date.now();
    startHeaderTimer(() => Date.now() - state.gameStartTs);
  }

  if (modeId === "training") $("score-counter").textContent = "‚Äî";
  else if (modeId === "sprint5") $("score-counter").textContent = "0";
  else $("score-counter").textContent = "0/0";
}

function startGame(modeId) {
  showScreen("screen-game");
  setupModeUI(modeId);

  state.hintUsesByKey = new Map();
  state.results = [];
  state.score = 0;
  state.currentIdx = 0;
  state.orders = [];
  state.memoryQueue = [];
  state.memoryActiveKey = null;

  resetMix();
  changeStep(1);

  const all = Object.keys(recipes);

  if (modeId === "training") return initTraining();
  if (modeId === "memory") return initMemory(all);

  if (modeId === "random20") state.orders = shuffle([...all]).slice(0, 20);
  else if (modeId === "marathon") state.orders = [...all];
  else if (modeId === "exam") state.orders = shuffle([...all]);
  else if (modeId === "sprint5") state.orders = shuffle([...all]);

  loadNextOrder();
}

function loadNextOrder() {
  if (state.finished) return;

  if (state.modeId === "sprint5") {
    const all = Object.keys(recipes);
    const name = all[Math.floor(Math.random() * all.length)];
    $("order-name").textContent = name;
    state.orderStartTs = Date.now();
    resetMix();
    changeStep(1);
    return;
  }

  const name = state.orders[state.currentIdx];
  $("order-name").textContent = name || "---";
  if (!name) return finishGame("All done!");

  state.orderStartTs = Date.now();
  resetMix();
  changeStep(1);

  $("score-counter").textContent = `${state.score}/${state.orders.length}`;
}

function finishGame(reason) {
  if (state.finished) return;
  state.finished = true;

  if (state.interval) clearInterval(state.interval);
  state.interval = null;
  stopHeaderTimer();
  $("hint-box").style.display = "none";

  const fastest = state.results.filter(r => r.durationMs != null).sort((a,b)=>a.durationMs-b.durationMs)[0] || null;
  const slowest = state.results.filter(r => r.durationMs != null).sort((a,b)=>b.durationMs-a.durationMs)[0] || null;

  const errorCounts = new Map();
  for (const r of state.results) {
    const n = errorCounts.get(r.name) || 0;
    errorCounts.set(r.name, n + (r.errors?.length || 0));
  }
  let mostErrName = null;
  let mostErrVal = -1;
  for (const [k,v] of errorCounts.entries()) {
    if (v > mostErrVal) { mostErrVal = v; mostErrName = k; }
  }

  $("results-sub").textContent = `${reason} ‚Ä¢ Score: ${state.score} ‚Ä¢ Served: ${state.results.length}`;
  $("res-fast").textContent = fastest ? `${fastest.name} ‚Ä¢ ${fmtDurationMs(fastest.durationMs)} ‚Ä¢ ${fastest.speedPerIng.toFixed(1)}s/ing` : "‚Äî";
  $("res-slow").textContent = slowest ? `${slowest.name} ‚Ä¢ ${fmtDurationMs(slowest.durationMs)} ‚Ä¢ ${slowest.speedPerIng.toFixed(1)}s/ing` : "‚Äî";
  $("res-most-errors").textContent = mostErrName ? `${mostErrName} ‚Ä¢ errors: ${mostErrVal}` : "‚Äî";

  const reco = [];
  if (state.results.some(r => r.hintUses > 0)) reco.push("Reduce hints: glass+method in first 2 seconds.");
  if (state.results.some(r => r.quality < 80)) reco.push("Accuracy: keep ¬±5ml and avoid extra ingredients.");
  if (state.modeId === "sprint5") reco.push("Sprint: aim ‚â§30s, use +20/+10 first, then fine-tune.");
  if (!reco.length) reco.push("Stable: optimize tab switches and transitions.");

  const ul = $("res-reco");
  ul.innerHTML = "";
  reco.forEach(t => {
    const li = document.createElement("li");
    li.textContent = t;
    ul.appendChild(li);
  });

  showScreen("screen-results");
}

/* ===== Training (fixed timer + submit flow) ===== */
function trainingNewMetrics() {
  return {
    start: performance.now(),
    firstGlassAt: null,
    firstToolAt: null,
    step12At: null,
    step23At: null,
    tabClicks: 0,
    pourClicksTotal: 0,
    pourClicksByAmt: { "1":0, "5":0, "10":0, "20":0 },
    totalClicks: 0
  };
}

function startTrainingLiveTimer() {
  stopTrainingLiveTimer();
  state.trainingLiveTimer = setInterval(() => {
    if (!(state.modeId === "training" && state.trainingAttemptActive)) return;

    const elapsed = (performance.now() - state.trainingMetrics.start) / 1000;
    $("training-live-time").textContent = `${elapsed.toFixed(1)}s`;

    const name = state.trainingName;
    if (name && recipes[name]) {
      const ingCount = Object.keys(recipes[name].ing).length;
      const goalSec = (goalMsByIngredients(ingCount) / 1000);
      const left = goalSec - elapsed;

      $("training-live-gap").textContent =
        `${elapsed.toFixed(1)}/${goalSec.toFixed(0)}s ‚Ä¢ ` +
        (left >= 0 ? `left ${left.toFixed(1)}s` : `over ${Math.abs(left).toFixed(1)}s`);
    }
  }, 100);
}

function stopTrainingLiveTimer() {
  if (state.trainingLiveTimer) clearInterval(state.trainingLiveTimer);
  state.trainingLiveTimer = null;
}

function trainingStartAttempt() {
  if (!state.trainingName) return;
  if (state.trainingAttemptActive) return;

  state.trainingAttemptActive = true;
  state.trainingAttemptStartTs = Date.now();
  state.trainingMetrics = trainingNewMetrics();

  resetMix();
  changeStep(1);

  $("training-live-time").textContent = "0.0s";
  $("training-live-clicks").textContent = "0";
  $("training-live-pour").textContent = "0";
  $("training-live-tabs").textContent = "0";

  startTrainingLiveTimer();
  // Header timer MUST show attempt time in Training:
  startHeaderTimer(() => Date.now() - state.trainingAttemptStartTs);
}

function trainingStopAttempt() {
  state.trainingAttemptActive = false;
  state.trainingAttemptStartTs = 0;
  stopTrainingLiveTimer();
  // After attempt ends, return to general mode timer (elapsed mode time)
  if (!state.mode.timed) {
    state.gameStartTs = state.gameStartTs || Date.now();
    startHeaderTimer(() => Date.now() - state.gameStartTs);
  }
}

function trainingTrackClick(kind, payload = {}) {
  if (state.modeId !== "training") return;
  if (!state.trainingAttemptActive) trainingStartAttempt();
  const m = state.trainingMetrics;

  m.totalClicks += 1;

  if (kind === "glass" && m.firstGlassAt === null) m.firstGlassAt = performance.now();
  if (kind === "tool" && m.firstToolAt === null) m.firstToolAt = performance.now();
  if (kind === "step12" && m.step12At === null) m.step12At = performance.now();
  if (kind === "step23" && m.step23At === null) m.step23At = performance.now();
  if (kind === "tab") m.tabClicks += 1;

  if (kind === "pour") {
    m.pourClicksTotal += 1;
    const a = String(payload.amt);
    if (m.pourClicksByAmt[a] !== undefined) m.pourClicksByAmt[a] += 1;
  }

  $("training-live-clicks").textContent = String(m.totalClicks);
  $("training-live-pour").textContent = String(m.pourClicksTotal);
  $("training-live-tabs").textContent = String(m.tabClicks);
}

function initTraining() {
  state.trainingName = null;
  state.trainingRepGoal = 5;
  state.trainingRepDone = 0;
  state.trainingBestMs = null;
  state.trainingAttemptActive = false;
  state.trainingAttemptStartTs = 0;
  state.trainingMetrics = null;
  state.trainingOpt = null;
  stopTrainingLiveTimer();

  $("training-bar").classList.add("hidden");
  $("training-live").classList.add("hidden");

  $("order-name").textContent = "Training";
  $("score-counter").textContent = "‚Äî";
  $("timer").textContent = "0:00";
  // keep header timer running (mode elapsed)
}

function trainingLoadCocktail() {
  const name = $("training-select").value;
  state.trainingName = name;
  state.trainingRepDone = 0;
  state.trainingBestMs = null;
  state.trainingOpt = computeOptimalForCocktail(name);
    const ingCount = Object.keys(recipes[name].ing).length;
  const goalMs = goalMsByIngredients(ingCount);
  $("training-goal").textContent = `${Math.round(goalMs/1000)}s`;

  const p = getCocktailProgress(name);
  const statusIcon = p ? (p.learned ? "üèÜ" : "‚è≥") : "üÜï";
  const avgTxt = p && p.avgLast5Ms != null ? `${(p.avgLast5Ms/1000).toFixed(1)}s` : "‚Äî";
  $("training-progress").textContent = `Avg(5): ${avgTxt} / Goal: ${(goalMs/1000).toFixed(0)}s ‚Ä¢ ${statusIcon}`;

$("training-bar").classList.remove("hidden");
$("training-live").classList.remove("hidden");

$("training-name").textContent = `üç∏ ${name}`;
// training-progress –ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç—É—Ç –≤—Ç–æ—Ä–æ–π —Ä–∞–∑ ‚Äî –æ–Ω —É–∂–µ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω –≤—ã—à–µ (Avg/Goal)
  $("training-opt").textContent = `${state.trainingOpt.optTotal} clicks`;

  $("order-name").textContent = `Training: ${name}`;
  $("score-counter").textContent = `0/${state.trainingRepGoal}`;

  resetMix();
  changeStep(1);
}

function trainingSubmit(garnishPicked) {
  if (!state.trainingName) return;
  if (!state.trainingAttemptActive) trainingStartAttempt();

  const name = state.trainingName;
  const target = recipes[name];
  const durationMs = Date.now() - state.trainingAttemptStartTs;
  const errsObj = validateBuild(target, garnishPicked);
  const errs = errsObj.map(e => e.msg);
  const ok = errs.length === 0;

  const m = state.trainingMetrics;
  const opt = state.trainingOpt || computeOptimalForCocktail(name);

  const ingCount = Object.keys(target.ing).length;
  const speedPerIng = durationMs / 1000 / Math.max(1, ingCount);
  const quality = computeQuality(errsObj);
 saveAttemptResult(name, durationMs, ingCount);
 renderStaticUI(); // –æ–±–Ω–æ–≤–∏—Ç –∏–∫–æ–Ω–∫–∏ üÜï/‚è≥/üèÜ –≤ —Å–µ–ª–µ–∫—Ç–µ
    const goalMs = goalMsByIngredients(ingCount);
  const p = getCocktailProgress(name);
  const statusIcon = p && p.learned ? "üèÜ" : "‚è≥";
  const avgTxt = p && p.avgLast5Ms != null ? `${(p.avgLast5Ms/1000).toFixed(1)}s` : "‚Äî";
  $("training-progress").textContent = `Avg(5): ${avgTxt} / Goal: ${(goalMs/1000).toFixed(0)}s ‚Ä¢ ${statusIcon}`;
    



  const tips = [];
  if (m.firstGlassAt) {
    const t = (m.firstGlassAt - m.start) / 1000;
    if (t > 2) tips.push(`Glass: ${t.toFixed(1)}s ‚Üí ‚â§2.0s`);
  }
  if (m.firstToolAt) {
    const t = (m.firstToolAt - m.start) / 1000;
    if (t > 2) tips.push(`Method: ${t.toFixed(1)}s ‚Üí ‚â§2.0s`);
  }
  const overClicks = m.totalClicks - opt.optTotal;
  if (overClicks >= 4) tips.push(`Clicks: ${m.totalClicks} vs ${opt.optTotal}`);
  const small = m.pourClicksByAmt["1"] + m.pourClicksByAmt["5"];
  const ratio = m.pourClicksTotal ? (small / m.pourClicksTotal) : 0;
  if (ratio > 0.5 && m.pourClicksTotal >= 8) tips.push(`Small pours: ${(ratio*100).toFixed(0)}%`);
  const tipLine = tips.slice(0,3).join(" | ");

  appendFeedbackCard({
    title: `üß© ${name}`,
    ok,
    hintUses: getHintUses(name),
    lines: [
      `‚è± ${fmtDurationMs(durationMs)} ‚Ä¢ ${speedPerIng.toFixed(1)}s/ing ‚Ä¢ Quality: ${quality}%`,
      `üñ± ${m.totalClicks}/${opt.optTotal} ‚Ä¢ üç∂ ${m.pourClicksTotal}/${opt.optPour} ‚Ä¢ üìë ${m.tabClicks}/${opt.optTabs}` + (tipLine ? ` ‚Ä¢ üëâ ${tipLine}` : "")
    ],
    errors: errs.length ? errs : null
  });

  state.trainingRepDone += 1;
  state.trainingBestMs = (state.trainingBestMs == null) ? durationMs : Math.min(state.trainingBestMs, durationMs);
  $("training-progress").textContent = `Attempt: ${state.trainingRepDone}/${state.trainingRepGoal} ‚Ä¢ Best: ${fmtDurationMs(state.trainingBestMs)}`;
  $("score-counter").textContent = `${Math.min(state.trainingRepDone, state.trainingRepGoal)}/${state.trainingRepGoal}`;

  state.results.push({ name, durationMs, speedPerIng, quality, errors: errs, hintUses: getHintUses(name) });

  trainingStopAttempt();
  resetMix();
  changeStep(1);
}

/* ===== Memory ===== */
function initMemory(allNames) {
  const total = MEMORY_ROUNDS * MEMORY_PER_ROUND;
  state.memoryQueue = shuffle([...allNames]).slice(0, total);
  state.memoryActiveKey = null;

  $("memory-hint").textContent = `Memorize ${total} names (2.5s each). Then: build + type name + serve.`;
  $("order-name").textContent = "Memory";
  $("score-counter").textContent = `0/${total}`;

  const h = $("hint-box");
  h.style.display = "none";

  let idx = 0;
  const reveal = () => {
    if (idx >= total) {
      h.style.display = "none";
      state.gameStartTs = Date.now();
      startHeaderTimer(() => Date.now() - state.gameStartTs);
      $("memory-hint").textContent = "Type cocktail name to select order.";
      return;
    }
    const name = state.memoryQueue[idx];
    h.textContent = `MEMORY\n\n${name}`;
    h.style.display = "block";
    idx += 1;
    setTimeout(() => {
      h.style.display = "none";
      setTimeout(reveal, 200);
    }, MEMORY_REVEAL_MS);
  };
  reveal();
}

function memoryConfirmName() {
  const txt = ($("memory-input").value || "").trim();
  const normalized = txt.toLowerCase();
  const found = state.memoryQueue.find(n => n.toLowerCase() === normalized);

  if (!found) {
    $("memory-hint").textContent = "Not found in your list. Check spelling.";
    return;
  }
  state.memoryActiveKey = found;
  $("order-name").textContent = `Memory: ${found}`;
  state.orderStartTs = Date.now();
  resetMix();
  changeStep(1);
  $("memory-hint").textContent = "Serve: pick garnish.";
}

function memoryForgotList() {
  const h = $("hint-box");
  h.textContent = "YOUR LIST:\n\n" + state.memoryQueue.join("\n");
  h.style.display = "block";
}

function memoryLeft() {
  const done = state.results.length;
  const total = MEMORY_ROUNDS * MEMORY_PER_ROUND;
  $("memory-hint").textContent = `Done: ${done}/${total} ‚Ä¢ Left: ${Math.max(0, total - done)}`;
}

function memorySubmit(garnishPicked) {
  if (!state.memoryActiveKey) {
    $("memory-hint").textContent = "Type a name and click ‚ÄúSelect order‚Äù first.";
    return;
  }
  const name = state.memoryActiveKey;
  const target = recipes[name];

  const durationMs = Date.now() - state.orderStartTs;
  const errsObj = validateBuild(target, garnishPicked);
  const errs = errsObj.map(e => e.msg);
  const ok = errs.length === 0;

  const ingCount = Object.keys(target.ing).length;
  const speedPerIng = durationMs / 1000 / Math.max(1, ingCount);
  const quality = computeQuality(errsObj);

  appendFeedbackCard({
    title: `üß† ${name}`,
    ok,
    hintUses: getHintUses(name),
    lines: [`‚è± ${fmtDurationMs(durationMs)} ‚Ä¢ ${speedPerIng.toFixed(1)}s/ing ‚Ä¢ Quality: ${quality}%`],
    errors: errs.length ? errs : null
  });

  state.results.push({ name, durationMs, speedPerIng, quality, errors: errs, hintUses: getHintUses(name) });
  if (ok) state.score += 1;

  state.memoryQueue = state.memoryQueue.filter(n => n !== name);
  state.memoryActiveKey = null;
  $("memory-input").value = "";

  const total = MEMORY_ROUNDS * MEMORY_PER_ROUND;
  $("score-counter").textContent = `${state.score}/${total}`;

  if (state.results.length >= total) return finishGame("Memory completed");
  $("order-name").textContent = "Memory";
  $("memory-hint").textContent = "Next: type the cocktail name.";
}

/* ===== Game submit flow (fixed: always works) ===== */
function submitCocktail(garnishPicked) {
  if (state.finished) return;

  if (state.modeId === "training") return trainingSubmit(garnishPicked);
  if (state.modeId === "memory") return memorySubmit(garnishPicked);

  const name = $("order-name").textContent;
  const target = recipes[name];
  if (!target) return;

  const durationMs = Date.now() - state.orderStartTs;
  const errsObj = validateBuild(target, garnishPicked);
  const errs = errsObj.map(e => e.msg);
  const ok = errs.length === 0;

  let quality = computeQuality(errsObj);
  quality = applySprintTimePenalty(quality, durationMs);

  const ingCount = Object.keys(target.ing).length;
  const speedPerIng = durationMs / 1000 / Math.max(1, ingCount);
  saveAttemptResult(name, durationMs, ingCount);
renderStaticUI();
    saveAttemptResult(name, durationMs, ingCount);
renderStaticUI();


  appendFeedbackCard({
    title: `üç∏ ${name}`,
    ok,
    hintUses: getHintUses(name),
    lines: [`‚è± ${fmtDurationMs(durationMs)} ‚Ä¢ ${speedPerIng.toFixed(1)}s/ing ‚Ä¢ Quality: ${quality}%`],
    errors: errs.length ? errs : null
  });

  state.results.push({ name, durationMs, speedPerIng, quality, errors: errs, hintUses: getHintUses(name) });
  if (ok) state.score += 1;

  if (state.modeId === "exam" && !ok) return finishGame("EXAM failed (1 mistake)");

  if (state.modeId === "sprint5") {
    $("score-counter").textContent = String(state.score);
    return loadNextOrder();
  }

  state.currentIdx += 1;
  $("score-counter").textContent = `${state.score}/${state.orders.length}`;
  if (state.currentIdx >= state.orders.length) return finishGame("All done!");
  loadNextOrder();
}

/* ===== Events (single delegation) ===== */
document.addEventListener("click", (e) => {
  const btn = e.target.closest("button");
  if (!btn) return;
  const action = btn.dataset.action;

  if (action === "start") return startGame(btn.dataset.mode);
  if (action === "toggle-music") return toggleMusic();
  if (action === "toggle-hint") return toggleHint();
  if (action === "reset-mix") return resetMix();

  if (action === "step") {
    const step = Number(btn.dataset.step);
    if (step === 2 && $("btn-step-2").disabled) return;
    if (state.modeId === "training") {
      trainingTrackClick(step === 2 ? "step12" : "step23");
    }
    return changeStep(step);
  }

  if (action === "tab") {
    const cat = btn.dataset.cat;
    $("tabs-bar").querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    if (state.modeId === "training") trainingTrackClick("tab");
    return renderBottles(cat);
  }

  if (action === "select-attr") {
    if (state.modeId === "training") trainingTrackClick(btn.dataset.key === "glass" ? "glass" : "tool");
    return selectAttr(btn.dataset.key, btn.dataset.value, btn);
  }

  if (action === "pour") {
    if (state.modeId === "training") trainingTrackClick("pour", { amt: btn.dataset.amt });
    return addIng(btn.dataset.ing, Number(btn.dataset.amt));
  }

  if (action === "submit") {
    if (state.modeId === "training") trainingTrackClick("garnish");
    return submitCocktail(btn.dataset.garnish);
  }

  if (action === "training-load") return trainingLoadCocktail();
  if (action === "training-start") return trainingStartAttempt();
  if (action === "training-reset") {
    // Stop attempt without breaking submit flow
    if (state.trainingAttemptActive) trainingStopAttempt();
    resetMix();
    changeStep(1);
    return;
  }

  if (action === "memory-confirm") return memoryConfirmName();
  if (action === "memory-forgot") return memoryForgotList();
  if (action === "memory-left") return memoryLeft();

  if (action === "back-menu") {
    if (state.interval) clearInterval(state.interval);
    stopHeaderTimer();
    state.finished = true;
    $("hint-box").style.display = "none";
    return showScreen("screen-menu");
  }
  if (action === "restart") {
    if (!state.lastModeId) return showScreen("screen-menu");
    return startGame(state.lastModeId);
  }
});

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") $("hint-box").style.display = "none";
});

/* Boot */
dataIntegrityCheckAndFix();
auditData();   // comment out if you don't want console logs
renderStaticUI();
</script>
</body>
</html>
